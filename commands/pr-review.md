# PR Review

PRのdiff全体を対象に、多面的なレビューを行う。
問題を見つけたら抽象的な指摘ではなく、具体的な修正案を提示する。

## タスク

$ARGUMENTS

## レビュー対象の取得

PRの差分を取得する:

```bash
# PR番号が指定された場合
gh pr diff $PR_NUMBER

# カレントブランチのPR
gh pr diff

# ベースブランチとの差分
git diff main...HEAD
```

$ARGUMENTS にPR番号またはURLが含まれている場合はそれを使用する。
指定がない場合はカレントブランチのPRを対象とする。

## レビュー観点

以下の5つの観点で順次レビューする。各観点で問題を発見したら、該当コードの引用と具体的な修正案をセットで提示する。

### 1. テストカバレッジ

- 新しく追加されたコードパスにテストがあるか
- エッジケースのテストが漏れていないか:
  - 空配列 / null / undefined
  - 境界値（0, -1, MAX_INT）
  - 空文字列 / 非常に長い文字列
  - 同時実行 / レースコンディション
- 既存テストが変更に追従しているか
- テストの品質: アサーションは適切か、テスト名は意図を表しているか

### 2. エラーハンドリング

- try-catch の範囲は適切か（広すぎ / 狭すぎ）
- エラーメッセージは具体的か（「エラーが発生しました」は不可）
- エラー時の状態管理: リソースリーク、不整合な状態にならないか
- 外部API呼び出しのエラーハンドリング: タイムアウト、リトライ、フォールバック
- ユーザー向けエラーとシステムログの分離

### 3. 型設計

- `any` の使用箇所: 適切な型に置き換え可能か
- `unknown` の使用: 型ガードで適切に絞り込まれているか
- ジェネリクスの活用: 型安全性を高められる箇所はないか
- Union型 / Discriminated Union の活用
- 型定義の重複: 共通の型を抽出できないか
- null/undefined の扱い: Optional chaining, Nullish coalescing の適切な使用

### 4. コード品質

- **可読性**: コードを上から下に読んで意図が理解できるか
- **命名**: 変数名・関数名が意図を正確に表しているか
- **関数の長さ**: 1関数 30行以上は分割を検討
- **引数の数**: 3つ以上はオブジェクトにまとめることを検討
- **DRY**: 重複コードがないか（ただし、無理な共通化は避ける）
- **コメント**: 「なぜ」を説明するコメントがあるか。不要なコメントがないか
- **一貫性**: 既存コードベースのスタイルに合っているか

### 5. シンプル化

- 過剰な抽象化: 必要以上のレイヤー、インターフェース、ラッパーがないか
- 不要な複雑性: もっとシンプルな書き方がないか
- 早すぎる最適化: パフォーマンスの問題が実証される前の複雑な最適化
- YAGNI: 現時点で不要な機能の先行実装
- 設計パターンの誤用: パターンのためのパターンになっていないか

## 出力フォーマット

各観点でのレビュー結果を以下の形式で出力する:

```
## レビューサマリー

### 1. テストカバレッジ
- [問題の重要度: Critical/Warning/Info] 問題の説明
  - 該当箇所: `ファイル名:行番号`
  - 修正案: 具体的なコード

### 2. エラーハンドリング
...

### 3. 型設計
...

### 4. コード品質
...

### 5. シンプル化
...

---

### 総合評価

- Critical: N件
- Warning: N件
- Info: N件

### 特に良い点
- ...
```

## ルール

- 全ての指摘に具体的な修正案を添える（「改善した方がいい」だけの指摘は禁止）
- 良い点も明示する（問題点だけでなくポジティブなフィードバックも）
- 重要度を明確にする（Critical: マージブロック / Warning: 推奨修正 / Info: 提案）
- 既存コードの問題は指摘しない（今回のPRで変更された部分のみ対象）
- コードスタイルの好みは指摘しない（プロジェクトの既存スタイルに従う）
