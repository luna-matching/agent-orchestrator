# Memory Management Protocol

コーディネーター（Nexus / 直接セッション）のメモリ管理ルール。

---

## Session Lifecycle

### セッション開始

1. `~/.claude/projects/{project}/memory/MEMORY.md` を読む
2. リンクされたトピックファイルがあれば必要に応じて読む
3. メモリの内容を踏まえて応答を開始する

**メモリなしでは、毎セッションがゼロからのスタートになる。**

### セッション中

- ユーザーの修正・指示は **即座に** メモリに永続化する
- 「保存して」を待たない。修正された時点で書き込む
- 明示的に「覚えて」と言われた内容も即時保存する

### セッション終了

- 重要な発見・パターンがあればメモリに追記して終了する

---

## Memory Structure

### MEMORY.md（インデックス）

- **60行以内** を厳守する
- 2行を超える詳細が必要なトピックはリンクファイルへ分離する
- セマンティック（トピック別）に整理する。時系列で並べない

```
# Memory

## User Preferences
- 修正指示は即座に永続化
- 出力は人間が判断できる形で直接提示する

## Project: [name]
- 詳細: [project-name.md](project-name.md) 参照
- キーポイント1
- キーポイント2
```

### トピック別ファイル

| ファイル名 | 用途 |
|-----------|------|
| `workflow.md` | ワークフロー原則の詳細 |
| `{project}.md` | プロジェクト固有の知識 |
| `debugging.md` | デバッグパターン・教訓 |
| `patterns.md` | コーディングパターン・規約 |

---

## 保存すべき内容

| 対象 | 例 |
|------|-----|
| 確認済みのパターン・規約 | 「このプロジェクトではbunを使う」 |
| アーキテクチャ決定 | 「認証はJWTではなくセッション方式」 |
| ユーザー嗜好 | 「コミットは自動で作らない」 |
| 繰り返す問題の解決策 | 「このライブラリはESM onlyでrequire不可」 |

## 保存すべきでない内容

| 対象 | 理由 |
|------|------|
| セッション固有の一時情報 | 次回には無関係 |
| 単一ファイルからの未検証の推測 | 誤情報リスク |
| CLAUDE.md と重複する内容 | 二重管理になる |
| 進行中の作業状態 | セッション内で完結すべき |

---

## Auto-Categorization

「save memory」指示を受けた場合:

1. 各項目のカテゴリを判定する
2. 該当するトピックファイルにルーティングする
3. MEMORY.md のインデックスを更新する
4. 既存エントリとの重複を確認し、重複があればマージする

---

## Integration with Agent Framework

- メモリは **コーディネーター層** の責務。個別エージェントはメモリを直接操作しない
- エージェント間の知識共有は `.agents/PROJECT.md` を使う（既存プロトコル）
- メモリはユーザーの嗜好・学習内容、PROJECT.md はプロジェクト固有の技術知識
